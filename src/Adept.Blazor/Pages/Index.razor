@page "/"
@using Adept.Data
@using Adept.Data.Model
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@implements IDisposable
@inject IRoutineRepository RoutineRepository;
@inject NavigationManager NavigationManager;
@inject RoutineState RoutineState;

@*<PageTitle>Index</PageTitle>*@

<MudText Typo="Typo.h3" GutterBottom="true">Hello!</MudText>
<MudText Typo="Typo.body1">@_welcomeText</MudText>
@if(_selectedRoutine == null)
{
    if (_routineCount == 0)
    {
        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@AddNewRoutine">Add new routine</MudButton>
    }
    else
    {
        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@SelectRoutine">Select routine</MudButton>
    }
}
else
{
    
    <MudText Class="mb-8">Next Workout is: </MudText>
    
    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@StartWorkout">Start workout</MudButton>
}


@code{
    internal Routine? _selectedRoutine;
    private int _routineCount;
    private string _welcomeText
    {
        get
        {
            return _selectedRoutine is null ?
                    (_routineCount == 0 ? "No routine found" : "No routine selected") :
                    "Current routine: " + _selectedRoutine.Name;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _selectedRoutine = RoutineState.SelectedRoutine;
        _routineCount = await RoutineRepository.GetRoutinesCountAsync();

        RoutineState.OnChange += StateHasChanged;
        await base.OnInitializedAsync();
    }


    public void Dispose()
    {
        RoutineState.OnChange -= StateHasChanged;
    }


    private async Task StartWorkout()
    {
        NavigationManager.NavigateTo("/workout");
    }

    private async Task AddNewRoutine()
    {
        NavigationManager.NavigateTo("/routine");
    }

    private async Task SelectRoutine()
    {
        NavigationManager.NavigateTo("/routine");
    }
}
