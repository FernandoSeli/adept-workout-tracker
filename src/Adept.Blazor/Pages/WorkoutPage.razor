@page "/workout"
@page "/workout/{workoutTemplateId:int}"

@using System.Text.Json
@using System.Text.Json.Serialization
@implements IDisposable
@inject RoutineState RoutineState;
@inject HttpClient Http;
@inject IExerciseRepository ExerciseRepository;
@inject IRoutineRepository RoutineRepository;
@inject NavigationManager NavigationManager;
@inject IDialogService DialogService;
@inject DialogHelper DialogHelper;


<MudText Typo="Typo.h3">Workout</MudText>
           
@code {
    [Parameter]
    public int WorkoutTemplateId { get; set; }

    private List<Routine> _routines = new List<Routine>();

    private bool open;
    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine(WorkoutTemplateId);
        var workoutTemplate = RoutineState.SelectedRoutine.WorkoutTemplates.FirstOrDefault(x => x.Id == WorkoutTemplateId);
        var workoutLog = new WorkoutLog(workoutTemplate);
        JsonSerializerOptions options = new()
        {
                ReferenceHandler = ReferenceHandler.IgnoreCycles,
                WriteIndented = true
            };
        var test =JsonSerializer.Serialize(workoutLog, options);
        await base.OnInitializedAsync();
    }


    public void Dispose()
    {
        RoutineState.OnChange -= StateHasChanged;
    }

    private async Task DeleteRoutine()
    {

        _routines = (await RoutineRepository.GetRoutinesAsync()).ToList();
        await RoutineRepository.RemoveAsync(_routines.FirstOrDefault());
    }
    private async Task AddRoutine()
    {

        var routine = await Http.GetFromJsonAsync<Routine>("/_content/Adept.Blazor/sample-data/Routine.json");
        await RoutineRepository.AddOrUpdateAsync(routine);
    }
    private async Task RefreshRoutine()
    {
        _routines = (await RoutineRepository.GetRoutinesAsync()).ToList();
    }

    private async Task OpenRoutineDialog(Routine routine)
    {
        var result = await DialogHelper.OpenRoutineDialogAsync(routine);
        
        _routines.AddUpdateOrDeleteRoutine(result.Routine, result.Deleted);
    }

    private async Task OpenWorkoutTemplateDialog(Routine routine, WorkoutTemplate workoutTemplate)
    {
        var result = await DialogHelper.OpenWorkoutTemplateDialogAsync(workoutTemplate);
        routine.WorkoutTemplates.AddUpdateOrDeleteWorkoutTemplate(result.WorkoutTemplate, result.Deleted);
    }


    private async Task SelectRoutine(Routine routine)
    {
        await RoutineRepository.AddOrUpdateCurrentRoutine(routine.Id);
        RoutineState.SetSelectedRoutine(routine);
    }
    
}
